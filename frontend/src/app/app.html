<div class="shell">
  <header class="masthead">
    <div>
      <p class="eyebrow">Healthcare AI Platform</p>
      <h1>{{ pageTitle() }}</h1>
      <p class="subtitle">{{ pageSubtitle() }}</p>
    </div>
    <div class="auth-chip">
      @if (currentUser) {
        <span>{{ currentUser.username }} ({{ currentUser.role }})</span>
        <button class="ghost inline" (click)="logout()">Logout</button>
      } @else {
        <span>Not signed in</span>
      }
    </div>
  </header>

  @if (message) {
    <div class="banner success">{{ message }}</div>
  }
  @if (error) {
    <div class="banner error">{{ error }}</div>
  }

  @if (!currentUser) {
    <section class="panel">
      <h2>Sign In</h2>
      <p>Default users: <code>admin/admin123</code>, <code>nurse/nurse123</code>, <code>ops/ops123</code>.</p>
      <div class="grid form-grid">
        <label>
          Username
          <input type="text" [(ngModel)]="loginForm.username" name="login_username" />
        </label>
        <label>
          Password
          <input type="password" [(ngModel)]="loginForm.password" name="login_password" />
        </label>
      </div>
      <button class="primary" (click)="login()" [disabled]="loading">
        {{ loading ? 'Signing in...' : 'Sign In' }}
      </button>
    </section>
  } @else {
    @if (mustChangePassword) {
      <section class="panel">
        <h2>Password Update Required</h2>
        <p>Your account must set a new password before accessing triage modules.</p>
        <div class="grid form-grid">
          <label>
            Current Password
            <input type="password" [(ngModel)]="passwordForm.current_password" name="current_password" />
          </label>
          <label>
            New Password
            <input type="password" [(ngModel)]="passwordForm.new_password" name="new_password" />
          </label>
          <label>
            Confirm New Password
            <input type="password" [(ngModel)]="passwordForm.confirm_password" name="confirm_password" />
          </label>
        </div>
        <button class="primary" (click)="changePassword()" [disabled]="loading">
          {{ loading ? 'Updating...' : 'Update Password' }}
        </button>
      </section>
    } @else {
      @if (!isOnboardingRoute()) {
        <nav class="boards" aria-label="Board Navigation">
          @for (board of availableBoards(); track board) {
            <button [class.active]="activeBoard === board" (click)="setBoard(board)">
              {{ boardLabel(board) }}
            </button>
          }
        </nav>
      }

      <router-outlet />

      @if (!isOnboardingRoute()) {
        <nav class="tabs" aria-label="Main Navigation">
          @if (isTabVisible('intake')) {
            <button [class.active]="activeTab === 'intake'" (click)="setTab('intake')">Intake</button>
          }
          @if (isTabVisible('queue') && canManageQueue()) {
            <button [class.active]="activeTab === 'queue'" (click)="setTab('queue')">Nurse Queue</button>
          }
          @if (isTabVisible('dashboard')) {
            <button [class.active]="activeTab === 'dashboard'" (click)="setTab('dashboard')">Dashboard</button>
          }
          @if (isTabVisible('audit')) {
            <button [class.active]="activeTab === 'audit'" (click)="setTab('audit')">Audit</button>
          }
        </nav>
      }

      @if (!isOnboardingRoute()) {
        @if (activeTab === 'intake') {
          <app-intake-panel
            [form]="intakeForm"
            [result]="intakeResult"
            [loading]="loading"
            (run)="runIntake()"
          />
        }

        @if (activeTab === 'queue' && canManageQueue()) {
          <app-queue-panel
            [items]="queueItems"
            [selectedQueueId]="selectedQueueId"
            [bookForm]="queueBookForm"
            [loading]="loading"
            (refresh)="refreshQueue()"
            (selectedQueueIdChange)="selectedQueueId = $event"
            (book)="bookQueueItem()"
          />
        }

        @if (activeTab === 'dashboard') {
          <app-dashboard-panel
            [metrics]="metrics"
            [appointmentRows]="appointmentRows"
            [activityRows]="activityRows"
            (refresh)="refreshDashboard()"
          />
        }

        @if (activeTab === 'audit') {
          <app-audit-panel
            [roleLabel]="audit?.role || currentUser.role"
            [auditRows]="auditRows"
            [auditLoaded]="!!audit"
            [triageRows]="auditTriageRows"
            [auditLogRows]="auditLogRows"
            (auditRowsChange)="auditRows = $event"
            (refresh)="refreshAudit()"
          />
        }
      }
    }
  }
</div>
